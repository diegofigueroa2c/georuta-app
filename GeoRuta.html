<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoRuta Express - Análisis de Logística</title>
    <!-- Incluir Tailwind CSS para diseño y estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir Lucide Icons para iconos limpios -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- NUEVO: Incluir Chart.js para gráficos dinámicos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Estilos personalizados para la tipografía Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .step-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }
        .metric-box {
            background-color: #fff;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Login Simulation / Overlay (Paso 0) -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center transition-opacity duration-500">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4 text-center">Acceso GeoRuta Express</h2>
            <p class="text-gray-600 mb-6 text-center">Inicie sesión para cargar su configuración guardada de Saltillo.</p>
            
            <input type="text" id="login-user" value="logistica1@saltillo.com" placeholder="Usuario" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            <input type="password" id="login-pass" value="saltillo123" placeholder="Contraseña" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
            
            <button id="login-button" class="w-full p-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150" onclick="simulateLogin()">
                Ingresar a la Plataforma
            </button>
            <p id="login-message" class="text-center text-sm mt-3 text-red-500 hidden">Credenciales incorrectas o error de autenticación.</p>
        </div>
    </div>

    <!-- Encabezado Fijo del Servicio -->
    <header class="bg-indigo-700 text-white shadow-lg sticky top-0 z-10 hidden" id="app-header">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tight">GeoRuta Express</h1>
            <div class="flex items-center space-x-4">
                <div id="admin-view" class="bg-yellow-500 text-gray-900 rounded-full py-1 px-3 text-sm font-bold hidden cursor-pointer hover:bg-yellow-400 transition" onclick="alert('Funcionalidad de Administrador: Aquí podría gestionar datos de todos los usuarios.')">
                    <i data-lucide="shield" class="w-4 h-4 inline mr-1"></i>
                    Vista Admin
                </div>
                <!-- NUEVO: Botón de Cerrar Sesión -->
                <button class="text-sm bg-indigo-500 rounded-full py-1 px-3 hover:bg-indigo-400 transition font-semibold" onclick="signOutUser()">
                    Cerrar Sesión
                </button>
                <!-- Indicador de Estado de la Sesión -->
                <div id="auth-status" class="flex items-center text-sm bg-indigo-600 rounded-full py-1 px-3">
                    <span id="status-dot" class="status-dot bg-yellow-400 animate-pulse"></span>
                    <span id="user-info">Cargando sesión...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Contenedor Principal -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 hidden" id="main-content">
        <h2 class="text-3xl font-semibold text-gray-800 mb-6">Análisis Operacional y Reportes con IA</h2>
        <p class="text-gray-600 mb-8">Registre sus viajes para obtener inteligencia de negocio y reducir costos operativos.</p>

        <!-- ZONA DE TRABAJO (3 PASOS) -->
        <div class="space-y-10">

            <!-- PASO 1: REGISTRO DE VIAJES COMPLETADOS -->
            <div id="step-1" class="step-card bg-white p-6 rounded-xl">
                <h3 class="flex items-center text-xl font-bold text-gray-700 mb-4">
                    <span class="bg-green-500 text-white w-8 h-8 flex items-center justify-center rounded-full mr-3 text-lg">1</span>
                    Registrar Viaje Completado
                </h3>
                <p class="text-sm text-gray-500 mb-4">Ingrese los datos de un viaje ya realizado para alimentar el historial de desempeño.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <!-- Campo de Vehículo (Dropdown) -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Unidad</label>
                        <select id="new-trip-vehicle" class="w-full p-2 border border-gray-300 rounded-lg text-sm"></select>
                    </div>
                     <!-- Campo de Fecha -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Fecha del Viaje</label>
                        <input type="date" id="new-trip-date" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <!-- KM Recorridos -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700">KM Recorridos (Actual)</label>
                        <input type="number" id="new-trip-km" placeholder="Ej: 215 km" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                    <!-- Litros Consumidos -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Litros de Diésel/Gas</label>
                        <input type="number" id="new-trip-fuel" placeholder="Ej: 35.5 L" step="0.1" class="w-full p-2 border rounded-lg text-sm">
                    </div>
                </div>
                <!-- Notas de Incidente -->
                <div class="mb-4">
                    <label class="block text-xs font-medium text-gray-700">Notas / Incidencias (Opcional)</label>
                    <input type="text" id="new-trip-notes" placeholder="Ej: Retraso 1.5h por accidente en Carr. 57" class="w-full p-2 border rounded-lg text-sm">
                </div>
                
                <button class="w-full px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150" onclick="logNewTrip()">
                    <i data-lucide="save" class="w-5 h-5 inline mr-2"></i>
                    Guardar Viaje al Historial
                </button>
                
                <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3">Historial de Operaciones Registradas</h4>
                <div id="trips-history" class="space-y-2 max-h-48 overflow-y-auto border p-3 rounded-lg bg-gray-50">
                    <p class="text-gray-500 text-sm" id="history-placeholder">No hay viajes registrados. ¡Comience a registrar!</p>
                </div>
            </div>

            <!-- PASO 2: GESTIÓN DE FLOTA (ASSETS) - Reutilizado -->
            <div id="step-2" class="step-card bg-white p-6 rounded-xl">
                <h3 class="flex items-center text-xl font-bold text-gray-700 mb-4">
                    <span class="bg-indigo-500 text-white w-8 h-8 flex items-center justify-center rounded-full mr-3 text-lg">2</span>
                    Gestión de Flota (Parámetros de Costo)
                </h3>
                <p class="text-sm text-gray-500 mb-4">Defina sus unidades. Estos parámetros se usan para calcular el rendimiento (KM/Litro).</p>
                
                <!-- Contenedor Dinámico de Vehículos -->
                <div id="vehicles-container" class="space-y-4">
                    <!-- Las tarjetas de vehículos se renderizarán aquí -->
                </div>

                <button class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 text-sm mt-4" onclick="addVehicle()">
                    <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                    Añadir Nueva Unidad
                </button>
            </div>
            
            <!-- PASO 3: ANÁLISIS DE INTELIGENCIA DE NEGOCIO CON IA -->
            <div id="step-3" class="step-card bg-white p-6 rounded-xl">
                <h3 class="flex items-center text-xl font-bold text-gray-700 mb-4">
                    <span class="bg-red-600 text-white w-8 h-8 flex items-center justify-center rounded-full mr-3 text-lg">3</span>
                    Generación de Reportes con IA
                </h3>
                <p class="text-sm text-gray-500 mb-4">Analice los datos históricos registrados en el Paso 1 para obtener reportes de desempeño y recomendaciones estratégicas.</p>

                <!-- Botón de Ejecución de Reporte -->
                <button id="ai-report-button" class="w-full px-6 py-3 bg-red-600 text-white text-lg font-bold rounded-lg hover:bg-red-700 transition duration-150 disabled:bg-gray-400" onclick="generateAIReport()">
                    <i data-lucide="wand-2" class="w-6 h-6 inline mr-2"></i>
                    Generar Reporte de IA y Recomendaciones
                </button>

                <!-- Área de Resultados del Reporte IA y Dashboard -->
                <div id="report-area" class="mt-8 hidden">
                    <h4 class="text-2xl font-semibold text-gray-800 mb-4">Reporte Estratégico de Desempeño (IA)</h4>
                    
                    <div id="report-content" class="bg-white p-6 border rounded-lg shadow-inner space-y-4">
                        <p id="ia-placeholder" class="text-gray-500 italic">El reporte de inteligencia artificial aparecerá aquí. Identificará unidades de bajo rendimiento, tendencias de consumo de combustible y sugerirá cambios operativos.</p>
                    </div>

                    <!-- Dashboard de Análisis Gráfico -->
                    <h4 class="text-2xl font-semibold text-gray-800 mb-4 mt-10">Dashboard de Rendimiento Gráfico</h4>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-xl shadow">
                            <h5 class="text-lg font-semibold mb-3 text-indigo-700">KM/L Promedio por Unidad</h5>
                            <canvas id="kmlChart"></canvas>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow">
                            <h5 class="text-lg font-semibold mb-3 text-indigo-700">Tendencia de Distancia vs. Combustible</h5>
                            <canvas id="distanceFuelChart"></canvas>
                        </div>
                    </div>
                    <!-- Fin Dashboard -->
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Inicializar iconos de Lucide
        lucide.createIcons();
        setLogLevel('debug');

        // 1. VARIABLES GLOBALES DEL ENTORNO CANVAS
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-georuta-app';
        let isFirebaseAvailable = false;
        let firebaseConfig = {};
        try {
            const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            firebaseConfig = JSON.parse(configString);
            // Si no hay API key o la config es mínima (como es el caso en local), forzamos el modo LocalStorage.
            if (firebaseConfig.apiKey && Object.keys(firebaseConfig).length > 2) { 
                isFirebaseAvailable = true;
            } else {
                 console.warn("Firebase configuration not detected or is incomplete. FORCING LOCAL STORAGE MODE.");
            }
        } catch (e) {
            console.error("Error parsing Firebase config:", e);
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- CONFIGURACIÓN DE LA API DE GEMINI ---
        const apiKey = "AIzaSyAD-P-pbiZ4rNCEKmynSx-JT7NKai5jKHA"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        // --- FIN CONFIGURACIÓN DE LA API DE GEMINI ---

        let db;
        let auth;
        let userId = null;
        let userRole = 'standard'; 
        
        // Variables para instancias de Chart.js
        let kmlChartInstance = null;
        let distanceFuelChartInstance = null;

        let appData = {
            // INICIAR VACÍO
            vehicles: [], 
            trips: []
        };

        
        // ** Credenciales Simuladas **
        const VALID_CREDENTIALS = {
            "admin@georuta.com": { pass: "admin123", role: "admin" },
            "logistica1@saltillo.com": { pass: "saltillo123", role: "standard" },
            "transporte2@saltillo.com": { pass: "saltillo456", role: "standard" }
        };

        // Función para mostrar el contenido principal y ocultar el login
        function showMainContent() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('app-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            
            if (userRole === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
            } else {
                document.getElementById('admin-view').classList.add('hidden');
            }
        }


        // 2. INICIALIZACIÓN Y AUTENTICACIÓN
        window.simulateLogin = async function() {
            const user = document.getElementById('login-user').value.toLowerCase().trim();
            const pass = document.getElementById('login-pass').value.trim();
            const loginButton = document.getElementById('login-button');
            const loginMessage = document.getElementById('login-message');
            const originalText = loginButton.innerHTML;

            loginButton.innerHTML = '<i data-lucide="loader" class="w-5 h-5 inline mr-2 animate-spin"></i> Verificando...';
            loginButton.disabled = true;
            loginMessage.classList.add('hidden');
            
            const credentials = VALID_CREDENTIALS[user];
            if (!credentials || credentials.pass !== pass) {
                loginMessage.textContent = "Usuario o Contraseña incorrectos.";
                loginMessage.classList.remove('hidden');
                loginButton.innerHTML = originalText;
                loginButton.disabled = false;
                lucide.createIcons();
                return;
            }
            
            userRole = credentials.role; 

            // Si Firebase está disponible (solo en entorno Canvas), iniciamos la conexión real.
            if (isFirebaseAvailable) {
                await initFirebase(); 
            } else {
                // FALLBACK: Usar el email como UID para localStorage
                userId = user; 
                // Actualizamos el estado para indicar que estamos en modo local
                updateAuthStatus('Modo Local (Sin Conexión)', 'bg-gray-500', 'text-white');
            }
            
            // Simulación visual de espera
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            
            if (userId) {
                // Cargar datos (ya sea de Firebase o localStorage)
                listenForData(); 
                showMainContent();
            } else {
                // Esto solo se dispara si la autenticación de Firebase falló catastróficamente.
                loginMessage.textContent = "Error al conectar con el servidor de autenticación.";
                loginMessage.classList.remove('hidden');
                loginButton.innerHTML = originalText;
                loginButton.disabled = false;
            }
            lucide.createIcons();
        }

        async function initFirebase() {
            if (!isFirebaseAvailable) return;
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        const displayUser = userRole === 'admin' ? 'ADMINISTRADOR' : 'Usuario Estándar';
                        updateAuthStatus(`${displayUser} (${userId.substring(0, 4)}...)`, 'bg-green-600', 'text-white');
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

                if (!auth.currentUser && initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(err => {
                        signInAnonymously(auth);
                    });
                } else if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                isFirebaseAvailable = false;
                updateAuthStatus('Modo Local (Error FB)', 'bg-gray-500', 'text-white');
            }
        }
        
        window.signOutUser = async function() {
            if (isFirebaseAvailable && auth) {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            }
            
            userId = null;
            userRole = 'standard';
            document.getElementById('app-header').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('login-overlay').classList.remove('hidden');
            
            document.getElementById('login-button').disabled = false;
            document.getElementById('login-button').innerHTML = 'Ingresar a la Plataforma';
            document.getElementById('login-message').classList.add('hidden');
            updateAuthStatus('Sesión cerrada', 'bg-yellow-400', 'text-gray-900');
            console.log("User signed out successfully.");
        }

        // 3. ESTRUCTURA DE LA BASE DE DATOS
        function getSessionDocRef() {
            if (!userId) return null;
            const path = `artifacts/${appId}/users/${userId}/georuta_settings`;
            return doc(db, path, 'current_session');
        }

        // 4. PERSISTENCIA DE DATOS (GUARDADO)
        let saveTimeout;
        window.debounceSave = function(delay = 1000) {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveSession, delay);
        }

        async function saveSession() {
            if (!userId) return;

            // 1. Recoger Vehículos (Paso 2)
            const vehicleElements = document.querySelectorAll('#vehicles-container .vehicle-card');
            appData.vehicles = Array.from(vehicleElements).map(el => {
                const id = parseInt(el.dataset.id);
                return {
                    id: id,
                    name: el.querySelector(`[name="vehicle-name-${id}"]`).value,
                    start_location: el.querySelector(`[name="vehicle-start-${id}"]`).value,
                    capacity: parseInt(el.querySelector(`[name="vehicle-capacity-${id}"]`).value || 0),
                    start_time: el.querySelector(`[name="vehicle-start-time-${id}"]`).value,
                    end_time: el.querySelector(`[name="vehicle-end-time-${id}"]`).value,
                };
            }).filter(v => v.name.trim() !== '');
            
            const dataToSave = { vehicles: appData.vehicles, trips: appData.trips };

            if (isFirebaseAvailable) {
                const docRef = getSessionDocRef();
                if (docRef) {
                    try {
                        await setDoc(docRef, dataToSave, { merge: true });
                        console.log("Session saved successfully to Firestore.");
                    } catch (e) {
                        console.error("Error saving document to Firestore:", e);
                    }
                }
            } else {
                // FALLBACK: Guardar en LocalStorage
                localStorage.setItem(`georuta_data_${userId}`, JSON.stringify(dataToSave));
                console.log("Session saved successfully to LocalStorage.");
            }
        }

        // 5. CARGA DE DATOS (LECTURA EN TIEMPO REAL)
        function listenForData() {
            if (isFirebaseAvailable) {
                const docRef = getSessionDocRef();
                if (docRef) {
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            appData.vehicles = data.vehicles || [];
                            appData.trips = data.trips || [];
                            renderUI(appData);
                            console.log("Data loaded/updated from Firestore.");
                        } else {
                            // Si no hay datos en Firebase, se cargan los defaults vacíos
                            console.log("No existing session found. Saving default data (empty).");
                            saveSession();
                        }
                    }, (error) => {
                        // ** CORRECCIÓN CLAVE: Fallback si fallan los permisos de Firestore **
                        console.error("Error listening to data:", error);
                        if (error.code === 'permission-denied' || error.message.includes('permissions')) {
                            isFirebaseAvailable = false; // Desactivar Firebase para el resto de la sesión
                            updateAuthStatus('Modo Local (PERMISO DENEGADO)', 'bg-red-600', 'text-white');
                            console.warn("Permission denied for Firestore. Switching to LocalStorage mode.");
                            
                            // Re-ejecutar la lógica de carga inmediatamente en LocalStorage mode
                            listenForData(); 
                            return;
                        }
                    });
                }
            } else {
                // FALLBACK: Cargar de LocalStorage
                const localData = localStorage.getItem(`georuta_data_${userId}`);
                if (localData) {
                    try {
                        const data = JSON.parse(localData);
                        appData.vehicles = data.vehicles || [];
                        appData.trips = data.trips || [];
                        console.log("Data loaded from LocalStorage.");
                    } catch (e) {
                        console.error("Error parsing LocalStorage data:", e);
                        appData.vehicles = [];
                        appData.trips = [];
                    }
                }
                renderUI(appData);
                // Si estamos en modo local y es la primera carga (datos vacíos), guardamos los defaults vacíos.
                if (appData.vehicles.length === 0 && appData.trips.length === 0) {
                     saveSession();
                }
            }
        }

        // 6. RENDERIZACIÓN DE LA INTERFAZ
        
        function renderVehicles() {
            const container = document.getElementById('vehicles-container');
            const vehicleSelect = document.getElementById('new-trip-vehicle');
            container.innerHTML = '';
            vehicleSelect.innerHTML = '';

            if (appData.vehicles.length === 0) {
                 vehicleSelect.innerHTML = `<option value="">Añadir unidad en Paso 2</option>`;
            }
            
            appData.vehicles.forEach(vehicle => {
                // Renderizar selector de viajes
                vehicleSelect.innerHTML += `<option value="${vehicle.id}">${vehicle.name}</option>`;

                // Renderizar tarjetas de configuración de vehículos (Paso 2)
                const vehicleCard = document.createElement('div');
                vehicleCard.className = 'vehicle-card border border-indigo-200 bg-indigo-50 p-4 rounded-lg space-y-3 mb-4';
                vehicleCard.dataset.id = vehicle.id;
                
                vehicleCard.innerHTML = `
                    <h4 class="font-semibold text-indigo-700 flex justify-between items-center">
                        <input type="text" name="vehicle-name-${vehicle.id}" value="${vehicle.name}" placeholder="Nombre de la Unidad (Ej: Camioneta N-001)" class="p-1 border rounded-md text-sm font-bold bg-white" oninput="debounceSave()">
                        <div class="flex items-center space-x-2">
                             <button class="text-red-500 hover:text-red-700 transition" onclick="removeVehicle(${vehicle.id})">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                            <i data-lucide="truck" class="w-5 h-5"></i>
                        </div>
                    </h4>
                    <input type="text" name="vehicle-start-${vehicle.id}" value="${vehicle.start_location}" placeholder="Punto de Inicio/Depósito (Ej: Calle Principal 123)" class="w-full p-2 border rounded-md text-sm" oninput="debounceSave()">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <input type="number" name="vehicle-capacity-${vehicle.id}" value="${vehicle.capacity}" placeholder="Capacidad Máx. (Ej: 100 UEC)" class="p-2 border rounded-md text-sm" oninput="debounceSave()">
                        <input type="time" name="vehicle-start-time-${vehicle.id}" value="${vehicle.start_time}" placeholder="Horario Inicio (HH:MM)" class="p-2 border rounded-md text-sm" oninput="debounceSave()">
                        <input type="time" name="vehicle-end-time-${vehicle.id}" value="${vehicle.end_time}" placeholder="Horario Fin (HH:MM)" class="p-2 border rounded-md text-sm" oninput="debounceSave()">
                    </div>
                `;
                container.appendChild(vehicleCard);
            });
            lucide.createIcons();
        }

        function renderTripsHistory() {
            const historyContainer = document.getElementById('trips-history');
            historyContainer.innerHTML = '';

            if (appData.trips.length === 0) {
                 historyContainer.innerHTML = `<p class="text-gray-500 text-sm" id="history-placeholder">No hay viajes registrados. ¡Comience a registrar!</p>`;
                 document.getElementById('ai-report-button').disabled = true;
                 return;
            }

            document.getElementById('ai-report-button').disabled = false;

            // Ordenar por fecha descendente
            const sortedTrips = [...appData.trips].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedTrips.forEach(trip => {
                const vehicle = appData.vehicles.find(v => v.id === trip.vehicle_id) || { name: 'Unidad Desconocida' };
                const tripElement = document.createElement('div');
                
                // Cálculo de Rendimiento (KM / Litro)
                const kml = (trip.distance_km / trip.fuel_liters).toFixed(2);
                const kmlColor = kml > 5.5 ? 'text-green-600' : (kml > 4.0 ? 'text-yellow-600' : 'text-red-600');

                tripElement.className = 'flex justify-between items-center p-2 bg-white rounded-md border border-gray-200 hover:shadow-sm';
                tripElement.innerHTML = `
                    <div class="text-sm">
                        <span class="font-semibold text-indigo-700">${vehicle.name}</span>
                        <span class="text-gray-500"> | ${trip.date}</span>
                        <p class="text-xs text-gray-500">${trip.distance_km} KM / ${trip.fuel_liters} L</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-bold ${kmlColor}">${kml} KM/L</span>
                        <button class="text-red-500 hover:text-red-700 transition" onclick="removeTrip(${trip.id})">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                historyContainer.appendChild(tripElement);
            });
            lucide.createIcons();
        }
        
        function renderUI(data) {
            renderVehicles();
            renderTripsHistory();
            
            // ** ACTUALIZACIÓN DE FECHA: Establecer la fecha actual en el input **
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('new-trip-date').value = today;
        }

        // 7. FUNCIONES DE MANIPULACIÓN DE DATOS (UI)

        function updateAuthStatus(message, dotClass, textClass) {
            const statusDot = document.getElementById('status-dot');
            const userInfo = document.getElementById('user-info');
            const authStatus = document.getElementById('auth-status');

            statusDot.className = `status-dot ${dotClass}`;
            userInfo.textContent = message;
            authStatus.className = `flex items-center text-sm rounded-full py-1 px-3 ${dotClass}`; 
        }

        window.logNewTrip = function() {
            const vehicleId = parseInt(document.getElementById('new-trip-vehicle').value);
            const date = document.getElementById('new-trip-date').value;
            const distance = parseFloat(document.getElementById('new-trip-km').value);
            const fuel = parseFloat(document.getElementById('new-trip-fuel').value);
            const notes = document.getElementById('new-trip-notes').value;

            if (!vehicleId || !date || isNaN(distance) || isNaN(fuel) || distance <= 0 || fuel <= 0) {
                alert('Por favor, complete los campos obligatorios (Unidad, Fecha, KM y Litros) con valores válidos y mayores a cero.');
                return;
            }

            const maxId = appData.trips.length > 0 ? Math.max(...appData.trips.map(t => t.id)) : 0;
            const newTrip = {
                id: maxId + 1,
                vehicle_id: vehicleId,
                date: date,
                distance_km: distance,
                fuel_liters: fuel,
                notes: notes,
                time_hours: (distance / 50).toFixed(1) // Simulación de tiempo basada en velocidad promedio
            };

            appData.trips.push(newTrip);

            // Limpiar formulario y guardar
            document.getElementById('new-trip-km').value = '';
            document.getElementById('new-trip-fuel').value = '';
            document.getElementById('new-trip-notes').value = '';
            
            renderTripsHistory();
            debounceSave(100);
        }

        window.removeTrip = function(id) {
            appData.trips = appData.trips.filter(t => t.id !== id);
            renderTripsHistory();
            debounceSave(100);
        }

        window.addVehicle = function() {
            const maxId = appData.vehicles.length > 0 ? Math.max(...appData.vehicles.map(v => v.id)) : 0;
            const newId = maxId + 1;
            
            const newVehicle = {
                id: newId,
                name: ``, // VACÍO
                start_location: "", // VACÍO
                capacity: 0, // 0
                start_time: "08:00", // Hora por defecto
                end_time: "17:00" // Hora por defecto
            };
            appData.vehicles.push(newVehicle);
            renderVehicles();
            debounceSave(100);
        }

        window.removeVehicle = function(id) {
            appData.vehicles = appData.vehicles.filter(v => v.id !== id);
            // También se deben eliminar los viajes asociados a este vehículo (Opcional, para simplificar)
            appData.trips = appData.trips.filter(t => t.vehicle_id !== id);
            renderVehicles();
            renderTripsHistory();
            debounceSave(100);
        }

        // 7.1. Generación de Gráficos (Dashboard)
        function renderDashboardCharts() {
            // 1. Procesar datos para el KM/L por Unidad (Gráfico de Barras)
            const vehiclePerformance = {};
            
            // 1.1 Agrupar datos
            appData.trips.forEach(trip => {
                const vehicle = appData.vehicles.find(v => v.id === trip.vehicle_id);
                if (!vehicle) return;
                
                if (!vehiclePerformance[vehicle.name]) {
                    vehiclePerformance[vehicle.name] = { totalKm: 0, totalFuel: 0, tripsCount: 0 };
                }
                vehiclePerformance[vehicle.name].totalKm += trip.distance_km;
                vehiclePerformance[vehicle.name].totalFuel += trip.fuel_liters;
                vehiclePerformance[vehicle.name].tripsCount++;
            });
            
            const labelsKML = Object.keys(vehiclePerformance);
            const dataKML = labelsKML.map(name => {
                const data = vehiclePerformance[name];
                return (data.totalKm / data.totalFuel).toFixed(2);
            });
            
            // 1.2 Destruir instancias antiguas
            if (kmlChartInstance) { kmlChartInstance.destroy(); }

            // 1.3 Crear Gráfico de Barras (KM/L)
            const ctxKML = document.getElementById('kmlChart').getContext('2d');
            kmlChartInstance = new Chart(ctxKML, {
                type: 'bar',
                data: {
                    labels: labelsKML,
                    datasets: [{
                        label: 'KM/L Promedio',
                        data: dataKML,
                        backgroundColor: labelsKML.map((_, i) => i % 2 === 0 ? 'rgba(59, 130, 246, 0.7)' : 'rgba(109, 40, 217, 0.7)'),
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Rendimiento (KM/L)'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // 2. Procesar datos para Tendencia (Gráfico de Líneas - Distancia vs. Combustible)
            
            // Ordenar viajes por fecha para la tendencia
            const sortedTripsByDate = [...appData.trips].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labelsTrend = sortedTripsByDate.map(t => `${t.date} (${appData.vehicles.find(v => v.id === t.vehicle_id)?.name || 'N/A'})`);

            // 2.2 Destruir instancias antiguas
            if (distanceFuelChartInstance) { distanceFuelChartInstance.destroy(); }

            // 2.3 Crear Gráfico de Líneas (Tendencia)
            const ctxTrend = document.getElementById('distanceFuelChart').getContext('2d');
            distanceFuelChartInstance = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: labelsTrend,
                    datasets: [
                        {
                            label: 'KM Recorridos',
                            data: sortedTripsByDate.map(t => t.distance_km),
                            borderColor: 'rgba(22, 163, 74, 1)',
                            backgroundColor: 'rgba(22, 163, 74, 0.2)',
                            yAxisID: 'y',
                            tension: 0.3 // Suavizar la línea
                        },
                        {
                            label: 'Litros Consumidos',
                            data: sortedTripsByDate.map(t => t.fuel_liters),
                            borderColor: 'rgba(234, 88, 12, 1)',
                            backgroundColor: 'rgba(234, 88, 12, 0.2)',
                            yAxisID: 'y1',
                            tension: 0.3 // Suavizar la línea
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    stacked: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Distancia (KM)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false, 
                            },
                             title: {
                                display: true,
                                text: 'Combustible (Litros)'
                            }
                        }
                    }
                }
            });
        }


        // ** FUNCIÓN DE IA: Generar Reporte y Recomendaciones **
        window.generateAIReport = async function() {
            if (appData.trips.length === 0) {
                alert('Debe registrar al menos un viaje para generar el reporte.');
                return;
            }

            const button = document.getElementById('ai-report-button');
            const reportArea = document.getElementById('report-area');
            const reportContent = document.getElementById('report-content');
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i data-lucide="loader" class="w-6 h-6 inline mr-2 animate-spin"></i> Analizando datos y generando reporte...';
            button.disabled = true;
            reportArea.classList.remove('hidden');
            reportContent.innerHTML = `<p class="text-gray-500 italic">Analizando ${appData.trips.length} viajes. Esto puede tomar unos segundos (llamada a Gemini API)...</p>`;

            // Lógica de cálculo del KML general y por unidad
            const totalTrips = appData.trips.length;
            const totalDistance = appData.trips.reduce((sum, t) => sum + t.distance_km, 0).toFixed(0);
            const totalFuel = appData.trips.reduce((sum, t) => sum + t.fuel_liters, 0);
            const avgKML = (totalDistance / totalFuel).toFixed(2);

            const performanceData = {};
            appData.trips.forEach(t => {
                const v = appData.vehicles.find(v => v.id === t.vehicle_id);
                const vName = v ? v.name : 'Unidad Desconocida';

                if (!performanceData[vName]) {
                    performanceData[vName] = { totalKm: 0, totalFuel: 0 };
                }
                performanceData[vName].totalKm += t.distance_km;
                performanceData[vName].totalFuel += t.fuel_liters;
            });
            
            let worstVehicleName = '';
            let bestVehicleName = '';
            let worstKML = Infinity;
            let bestKML = 0;

            for (const name in performanceData) {
                const avgKMLForVehicle = performanceData[name].totalKm / performanceData[name].totalFuel;
                if (avgKMLForVehicle < worstKML) {
                    worstKML = avgKMLForVehicle;
                    worstVehicleName = name;
                }
                if (avgKMLForVehicle > bestKML) {
                    bestKML = avgKMLForVehicle;
                    bestVehicleName = name;
                }
            }

            // --- CONSTRUCCIÓN DEL PROMPT PARA LA API ---
            const dataSummary = appData.trips.map(t => {
                const vehicle = appData.vehicles.find(v => v.id === t.vehicle_id) || { name: 'Desconocido' };
                const kml = (t.distance_km / t.fuel_liters).toFixed(2);
                return `Viaje ID ${t.id} (${vehicle.name}, ${t.date}): ${t.distance_km} KM, ${t.fuel_liters} L, ${kml} KM/L. Notas: ${t.notes || 'Ninguna.'}`;
            }).join('\n');

            const systemPrompt = `Eres un consultor de logística de alto nivel. Tu tarea es analizar los datos de rendimiento de una flota de transporte en Saltillo. Debes generar un reporte estructurado y profesional usando etiquetas HTML (principalmente <div>, <h3>, <p>, <ul>, <strong> y <ol>) para máxima claridad. NO uses Markdown (**). El tono debe ser analítico, estratégico y enfocado en la reducción de costos.`;
            
            const userQuery = `Analiza el siguiente resumen de datos operativos. El rendimiento promedio general de la flota es de ${avgKML} KM/L. La unidad con peor desempeño es "${worstVehicleName}" (${worstKML.toFixed(2)} KM/L) y la unidad con mejor desempeño es "${bestVehicleName}" (${bestKML.toFixed(2)} KM/L).

            Genera una respuesta en español estructurada que incluya:
            1.  Un resumen ejecutivo (Título: RESUMEN EJECUTIVO DE RENDIMIENTO) que destaque los hallazgos críticos (mejor/peor unidad, promedio general).
            2.  Una sección de 3 recomendaciones estratégicas (Título: 3 RECOMENDACIONES ESTRATÉGICAS) para mejorar la eficiencia y el rendimiento.

            Los datos detallados de los viajes son:
            ${dataSummary}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            // 3. LLAMADA REAL A LA API
            let generatedText = `<p class="text-gray-500 italic">Error: El modelo de IA no pudo conectarse o generar contenido.</p>`;
            
            try {
                // Implementación de reintento con retroceso exponencial
                for (let i = 0; i < 3; i++) { // Intentar hasta 3 veces
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || generatedText;
                        break; // Salir del bucle si es exitoso
                    } else if (response.status === 429 || response.status >= 500) {
                        // Error de tasa límite o servidor, esperar y reintentar
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        if (i === 2) throw new Error(`Fallo después de 3 intentos. Último estado: ${response.status}`);
                    } else {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                }

            } catch (error) {
                console.error("Error al conectar o procesar la API de Gemini:", error);
                generatedText = `<p class="text-red-600 font-bold">ERROR AL GENERAR EL REPORTE:</p><p class="text-red-500">No se pudo conectar con la API de IA. Mensaje: ${error.message}</p>`;
            }

            // 4. Mostrar Resultados y Dashboard
            reportContent.innerHTML = generatedText; 
            renderDashboardCharts(); 
            
            button.innerHTML = originalText;
            button.disabled = false;
            lucide.createIcons();
        }

        // 8. INICIO DE LA APLICACIÓN
        // La inicialización de Firebase se realiza dentro de simulateLogin()

    </script>
</body>
</html>